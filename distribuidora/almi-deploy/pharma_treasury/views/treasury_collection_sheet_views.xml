<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista List de Hoja de Cobranza -->
    <record id="view_treasury_collection_sheet_list" model="ir.ui.view">
        <field name="name">treasury.collection.sheet.list</field>
        <field name="model">treasury.collection.sheet</field>
        <field name="arch" type="xml">
            <list string="Hojas de Cobranza">
                <field name="name" string="Número"/>
                <field name="salesperson_id"/>
                <field name="date_from"/>
                <field name="date_to"/>
                <field name="total_invoices" string="Facturas"/>
                <field name="total_assigned" sum="Asignado"/>
                <field name="total_collected" sum="Cobrado"/>
                <field name="pending_amount" sum="Pendiente"/>
                <field name="collection_rate" string="% Efectividad" widget="progressbar"/>
                <field name="state" widget="badge" 
                       decoration-info="state == 'draft'"
                       decoration-success="state == 'active'"
                       decoration-muted="state == 'closed'"/>
                <field name="company_id" groups="base.group_multi_company"/>
            </list>
        </field>
    </record>

    <!-- Vista Form de Hoja de Cobranza -->
    <record id="view_treasury_collection_sheet_form" model="ir.ui.view">
        <field name="name">treasury.collection.sheet.form</field>
        <field name="model">treasury.collection.sheet</field>
        <field name="arch" type="xml">
            <form string="Hoja de Cobranza">
                <header>
                    <button name="action_activate" string="Activar" type="object" 
                            class="oe_highlight" invisible="state != 'draft'"/>
                    <button name="action_load_invoices" string="Cargar Facturas" type="object" 
                            invisible="state != 'draft'"/>
                    <button name="action_close" string="Cerrar" type="object" 
                            invisible="state != 'active'"
                            groups="account.group_account_manager"/>
                    <button name="action_reset_to_draft" string="Reiniciar" type="object" 
                            invisible="state != 'active'"
                            groups="account.group_account_manager"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,active,closed"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_invoices" type="object" 
                                class="oe_stat_button" icon="fa-file-text-o">
                            <field name="total_invoices" widget="statinfo" 
                                   string="Facturas"/>
                        </button>
                        <button name="action_view_paid_invoices" type="object" 
                                class="oe_stat_button" icon="fa-check-circle"
                                invisible="paid_invoices == 0">
                            <field name="paid_invoices" widget="statinfo" 
                                   string="Pagadas"/>
                        </button>
                        <button name="action_view_unpaid_invoices" type="object" 
                                class="oe_stat_button" icon="fa-exclamation-circle"
                                invisible="unpaid_invoices == 0">
                            <field name="unpaid_invoices" widget="statinfo" 
                                   string="Pendientes"/>
                        </button>
                    </div>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group>
                            <field name="salesperson_id" readonly="state != 'draft'"/>
                            <field name="date_from" readonly="state != 'draft'"/>
                            <field name="date_to" readonly="state != 'draft'"/>
                        </group>
                        <group>
                            <field name="currency_id" invisible="1"/>
                            <field name="activation_date" readonly="1"/>
                            <field name="closing_date" readonly="1"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                    </group>
                    
                    <!-- Dashboard con indicadores -->
                    <group string="Resumen de Cobranza" class="mt-3">
                        <group>
                            <field name="total_assigned" widget="monetary" readonly="1"/>
                            <field name="total_collected" widget="monetary" readonly="1"/>
                            <field name="pending_amount" widget="monetary" readonly="1"/>
                        </group>
                        <group>
                            <field name="collection_rate" widget="percentage" readonly="1"/>
                            <div class="o_horizontal_separator">Distribución</div>
                            <div>
                                <field name="paid_invoices" readonly="1" class="oe_inline"/> Pagadas /
                                <field name="partial_invoices" readonly="1" class="oe_inline"/> Parciales /
                                <field name="unpaid_invoices" readonly="1" class="oe_inline"/> Sin Pagar
                            </div>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Facturas" name="invoices">
                            <field name="invoice_ids" readonly="state != 'draft'">
                                <list>
                                    <field name="name"/>
                                    <field name="partner_id"/>
                                    <field name="invoice_date"/>
                                    <field name="invoice_date_due"/>
                                    <field name="amount_total" sum="Total"/>
                                    <field name="amount_residual" sum="Pendiente"/>
                                    <field name="payment_state" 
                                           widget="badge"
                                           decoration-success="payment_state in ['paid', 'in_payment']"
                                           decoration-warning="payment_state == 'partial'"
                                           decoration-danger="payment_state == 'not_paid'"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Análisis" name="analysis">
                            <group>
                                <group string="Totales">
                                    <field name="total_invoices" readonly="1"/>
                                    <field name="paid_invoices" readonly="1"/>
                                    <field name="partial_invoices" readonly="1"/>
                                    <field name="unpaid_invoices" readonly="1"/>
                                </group>
                                <group string="Montos">
                                    <field name="total_assigned" widget="monetary" readonly="1"/>
                                    <field name="total_collected" widget="monetary" readonly="1"/>
                                    <field name="pending_amount" widget="monetary" readonly="1"/>
                                    <field name="collection_rate" widget="percentage" readonly="1"/>
                                </group>
                            </group>
                            
                            <!-- Gráfico de efectividad -->
                            <div class="row mt-3" invisible="state == 'draft'">
                                <div class="col-12">
                                    <div class="alert alert-success" role="alert" 
                                         invisible="collection_rate &lt; 80">
                                        <i class="fa fa-check-circle"/> Excelente desempeño de cobranza
                                    </div>
                                    <div class="alert alert-warning" role="alert" 
                                         invisible="collection_rate &lt; 50 or collection_rate &gt;= 80">
                                        <i class="fa fa-exclamation-triangle"/> Desempeño de cobranza aceptable
                                    </div>
                                    <div class="alert alert-danger" role="alert" 
                                         invisible="collection_rate &gt;= 50">
                                        <i class="fa fa-times-circle"/> Bajo desempeño de cobranza
                                    </div>
                                </div>
                            </div>
                        </page>
                        
                        <page string="Observaciones" name="notes">
                            <field name="notes" placeholder="Notas adicionales sobre la hoja de cobranza..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Vista Kanban de Hoja de Cobranza -->
    <record id="view_treasury_collection_sheet_kanban" model="ir.ui.view">
        <field name="name">treasury.collection.sheet.kanban</field>
        <field name="model">treasury.collection.sheet</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="name"/>
                <field name="salesperson_id"/>
                <field name="date_from"/>
                <field name="date_to"/>
                <field name="total_invoices"/>
                <field name="collection_rate"/>
                <field name="total_assigned"/>
                <field name="total_collected"/>
                <field name="state"/>
                <templates>
                    <t t-name="card">
                        <div class="row">
                            <div class="col-8">
                                <strong><field name="name"/></strong>
                            </div>
                            <div class="col-4 text-end">
                                <field name="state" widget="badge"/>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <span><i class="fa fa-user"/> <field name="salesperson_id"/></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <span class="text-muted">
                                    <i class="fa fa-calendar"/> 
                                    <field name="date_from"/> - <field name="date_to"/>
                                </span>
                            </div>
                        </div>
                        <hr class="mt-2 mb-2"/>
                        <div class="row">
                            <div class="col-6">
                                <span class="text-muted">Facturas:</span>
                            </div>
                            <div class="col-6 text-end">
                                <strong><field name="total_invoices"/></strong>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <span class="text-muted">Efectividad:</span>
                            </div>
                            <div class="col-6 text-end">
                                <strong>
                                    <field name="collection_rate" widget="float" 
                                           t-att-class="record.collection_rate.raw_value &gt;= 80 ? 'text-success' : (record.collection_rate.raw_value &gt;= 50 ? 'text-warning' : 'text-danger')"/>%
                                </strong>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <span class="text-muted">Cobrado:</span>
                            </div>
                            <div class="col-6 text-end">
                                <strong><field name="total_collected" widget="monetary"/></strong>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <span class="text-muted">Total:</span>
                            </div>
                            <div class="col-6 text-end">
                                <field name="total_assigned" widget="monetary"/>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vista Search de Hoja de Cobranza -->
    <record id="view_treasury_collection_sheet_search" model="ir.ui.view">
        <field name="name">treasury.collection.sheet.search</field>
        <field name="model">treasury.collection.sheet</field>
        <field name="arch" type="xml">
            <search string="Buscar Hojas de Cobranza">
                <field name="name" string="Hoja"/>
                <field name="salesperson_id" string="Vendedor"/>
                <separator/>
                <filter string="Borrador" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Activas" name="active" domain="[('state', '=', 'active')]"/>
                <filter string="Cerradas" name="closed" domain="[('state', '=', 'closed')]"/>
                <separator/>
                <filter string="Alta Efectividad (&gt;=80%)" name="high_performance" 
                        domain="[('collection_rate', '&gt;=', 80)]"/>
                <filter string="Baja Efectividad (&lt;50%)" name="low_performance" 
                        domain="[('collection_rate', '&lt;', 50)]"/>
                <separator/>
                <filter string="Fecha Inicio" name="date_from" date="date_from"/>
                <filter string="Fecha Fin" name="date_to" date="date_to"/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Vendedor" name="group_salesperson" context="{'group_by': 'salesperson_id'}"/>
                    <filter string="Estado" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Mes" name="group_month" context="{'group_by': 'date_from:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Vista Pivot de Hoja de Cobranza -->
    <record id="view_treasury_collection_sheet_pivot" model="ir.ui.view">
        <field name="name">treasury.collection.sheet.pivot</field>
        <field name="model">treasury.collection.sheet</field>
        <field name="arch" type="xml">
            <pivot string="Análisis de Cobranza">
                <field name="salesperson_id" type="row"/>
                <field name="total_assigned" type="measure"/>
                <field name="total_collected" type="measure"/>
                <field name="pending_amount" type="measure"/>
                <field name="total_invoices" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Vista Graph de Hoja de Cobranza -->
    <record id="view_treasury_collection_sheet_graph" model="ir.ui.view">
        <field name="name">treasury.collection.sheet.graph</field>
        <field name="model">treasury.collection.sheet</field>
        <field name="arch" type="xml">
            <graph string="Gráfico de Cobranza" type="bar">
                <field name="salesperson_id"/>
                <field name="total_collected" type="measure"/>
                <field name="pending_amount" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Acción de Hoja de Cobranza -->
    <record id="action_treasury_collection_sheet" model="ir.actions.act_window">
        <field name="name">Hojas de Cobranza</field>
        <field name="res_model">treasury.collection.sheet</field>
        <field name="view_mode">list,form,kanban,pivot,graph</field>
        <field name="context">{'search_default_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crear una nueva Hoja de Cobranza
            </p>
            <p>
                Las hojas de cobranza permiten hacer seguimiento de las facturas asignadas a cada vendedor y medir su efectividad.
            </p>
        </field>
    </record>

</odoo>

