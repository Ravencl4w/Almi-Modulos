<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extender Form View de Facturas -->
    <record id="view_account_move_form_inherit_dispatch" model="ir.ui.view">
        <field name="name">account.move.form.inherit.dispatch</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <!-- Agregar botón en el button_box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_dispatch_sheets" type="object" 
                        class="oe_stat_button" icon="fa-truck"
                        invisible="dispatch_sheet_count == 0 or move_type != 'out_invoice'">
                    <field name="dispatch_sheet_count" widget="statinfo" string="Planillas"/>
                </button>
            </xpath>
            
            <!-- Agregar campos invisibles necesarios -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="dispatch_sheet_ids" invisible="1"/>
                <field name="dispatch_sheet_count" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!-- Acción de servidor para crear planilla desde facturas seleccionadas -->
    <record id="action_create_dispatch_sheet_from_invoices" model="ir.actions.server">
        <field name="name">Crear Planilla de Despacho</field>
        <field name="model_id" ref="account.model_account_move"/>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    action = {
        'name': 'Crear Planilla de Despacho',
        'type': 'ir.actions.act_window',
        'res_model': 'create.sheet.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': {
            'active_ids': records.ids,
            'active_model': 'account.move',
        }
    }
        </field>
    </record>

</odoo>

