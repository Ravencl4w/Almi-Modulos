<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Form View Extension -->
    <record id="view_sale_order_form_pickup" model="ir.ui.view">
        <field name="name">sale.order.form.pickup</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <!-- Agregar botones en el header -->
            <xpath expr="//header/button[@name='action_confirm']" position="after">
                <field name="delivery_type" invisible="1"/>
                <field name="pickup_state" invisible="1"/>
                
                <button name="action_mark_ready_for_pickup" type="object"
                        string="Marcar Listo para Recoger"
                        invisible="delivery_type != 'pickup' or pickup_state != 'reserved'"
                        class="oe_highlight"/>
                
                <button name="action_mark_picked_up" type="object"
                        string="Registrar Recojo"
                        invisible="delivery_type != 'pickup' or pickup_state != 'ready'"
                        class="oe_highlight"/>
            </xpath>
            
            <!-- Agregar statusbar para estado de recojo -->
            <xpath expr="//header/field[@name='state']" position="after">
                <field name="pickup_state" widget="statusbar"
                       statusbar_visible="reserved,ready,picked_up"
                       invisible="delivery_type != 'pickup'"/>
            </xpath>
            
            <!-- Agregar campos de entrega después del cliente -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="delivery_type" widget="radio" options="{'horizontal': true}"/>
            </xpath>
            
            <!-- Agregar pestaña de Recojo en Local -->
            <xpath expr="//notebook" position="inside">
                <page string="Recojo en Local" name="pickup"
                      invisible="delivery_type != 'pickup'">
                    <group>
                        <group string="Estado del Recojo">
                            <field name="pickup_reservation_date" readonly="1"/>
                            <field name="pickup_ready_date" readonly="1"/>
                            <field name="pickup_date" readonly="1"/>
                            <field name="pickup_deadline"/>
                        </group>
                        <group string="Ubicación">
                            <field name="pickup_location_id" 
                                   options="{'no_create': True}"/>
                        </group>
                    </group>
                    
                    <group>
                        <group string="Notificación">
                            <field name="customer_notified" readonly="1"/>
                            <field name="notification_sent_date" readonly="1"/>
                        </group>
                        <group string="Información de Recojo">
                            <field name="picked_up_by"/>
                            <field name="pickup_dni"/>
                        </group>
                    </group>
                    
                    <group string="Notas de Recojo">
                        <field name="pickup_notes" nolabel="1" 
                               placeholder="Notas adicionales sobre el recojo..."/>
                    </group>
                </page>
                
                <page string="Ruta de Reparto" name="route"
                      invisible="delivery_type != 'delivery'">
                    <group>
                        <group string="Asignación de Ruta">
                            <field name="route_id"/>
                            <field name="route_line_id" readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- List View Extension -->
    <record id="view_sale_order_list_pickup" model="ir.ui.view">
        <field name="name">sale.order.list.pickup</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//list" position="attributes">
                <attribute name="decoration-success">delivery_type == 'pickup' and pickup_state == 'picked_up'</attribute>
                <attribute name="decoration-warning">delivery_type == 'pickup' and pickup_state == 'ready'</attribute>
                <attribute name="decoration-info">delivery_type == 'pickup' and pickup_state == 'reserved'</attribute>
                <attribute name="decoration-danger">delivery_type == 'pickup' and pickup_state == 'expired'</attribute>
            </xpath>
            <xpath expr="//field[@name='state']" position="after">
                <field name="delivery_type" optional="show"/>
                <field name="pickup_state" optional="show"
                       invisible="delivery_type != 'pickup'"
                       widget="badge"
                       decoration-success="pickup_state == 'picked_up'"
                       decoration-warning="pickup_state == 'ready'"
                       decoration-info="pickup_state == 'reserved'"
                       decoration-danger="pickup_state == 'expired'"/>
            </xpath>
        </field>
    </record>

    <!-- Kanban View for Pickup Orders -->
    <record id="view_sale_order_pickup_kanban" model="ir.ui.view">
        <field name="name">sale.order.pickup.kanban</field>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <kanban default_group_by="pickup_state" class="o_kanban_small_column">
                <field name="id"/>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="amount_total"/>
                <field name="currency_id"/>
                <field name="state"/>
                <field name="pickup_state"/>
                <field name="pickup_deadline"/>
                <field name="customer_notified"/>
                <field name="pickup_location_id"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top mb8">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                    <div class="text-muted">
                                        <field name="partner_id"/>
                                    </div>
                                </div>
                                <div class="o_dropdown_kanban dropdown">
                                    <a role="button" class="dropdown-toggle o-no-caret btn" data-toggle="dropdown" href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                        <span class="fa fa-ellipsis-v"/>
                                    </a>
                                    <div class="dropdown-menu" role="menu">
                                        <t t-if="record.pickup_state.raw_value == 'reserved'">
                                            <a role="menuitem" type="object" name="action_mark_ready_for_pickup" class="dropdown-item">
                                                Marcar Listo para Recoger
                                            </a>
                                        </t>
                                        <t t-if="record.pickup_state.raw_value == 'ready'">
                                            <a role="menuitem" type="object" name="action_mark_picked_up" class="dropdown-item">
                                                Registrar Recojo
                                            </a>
                                        </t>
                                        <a role="menuitem" type="edit" class="dropdown-item">Editar</a>
                                        <div role="separator" class="dropdown-divider"/>
                                        <a role="menuitem" type="delete" class="dropdown-item">Eliminar</a>
                                    </div>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>
                                    <i class="fa fa-money"/> 
                                    <field name="amount_total" widget="monetary" 
                                           options="{'currency_field': 'currency_id'}"/>
                                </div>
                                <div t-if="record.pickup_deadline.raw_value">
                                    <i class="fa fa-calendar"/> 
                                    Hasta: <field name="pickup_deadline"/>
                                </div>
                                <div t-if="record.pickup_location_id.raw_value">
                                    <i class="fa fa-map-marker"/> 
                                    <field name="pickup_location_id"/>
                                </div>
                                <div class="mt8">
                                    <t t-if="record.customer_notified.raw_value">
                                        <span class="badge badge-success">
                                            <i class="fa fa-check"/> Cliente notificado
                                        </span>
                                    </t>
                                    <t t-else="">
                                        <span class="badge badge-secondary">
                                            <i class="fa fa-clock-o"/> Sin notificar
                                        </span>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Search View Extension -->
    <record id="view_sale_order_search_pickup" model="ir.ui.view">
        <field name="name">sale.order.search.pickup</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="Recojo en Local" name="pickup"
                        domain="[('delivery_type', '=', 'pickup')]"/>
                <filter string="Entrega a Domicilio" name="delivery"
                        domain="[('delivery_type', '=', 'delivery')]"/>
                <separator/>
                <filter string="Reservados" name="pickup_reserved"
                        domain="[('delivery_type', '=', 'pickup'), ('pickup_state', '=', 'reserved')]"/>
                <filter string="Listos para Recoger" name="pickup_ready"
                        domain="[('delivery_type', '=', 'pickup'), ('pickup_state', '=', 'ready')]"/>
                <filter string="Recogidos" name="pickup_picked_up"
                        domain="[('delivery_type', '=', 'pickup'), ('pickup_state', '=', 'picked_up')]"/>
                <filter string="Expirados" name="pickup_expired"
                        domain="[('delivery_type', '=', 'pickup'), ('pickup_state', '=', 'expired')]"/>
                <separator/>
                <filter string="Cliente Notificado" name="customer_notified"
                        domain="[('customer_notified', '=', True)]"/>
                <separator/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Tipo de Entrega" name="group_delivery_type"
                            context="{'group_by': 'delivery_type'}"/>
                    <filter string="Estado de Recojo" name="group_pickup_state"
                            context="{'group_by': 'pickup_state'}"/>
                    <filter string="Ubicación de Recojo" name="group_pickup_location"
                            context="{'group_by': 'pickup_location_id'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Action for Pickup Orders -->
    <record id="action_sale_order_pickup" model="ir.actions.act_window">
        <field name="name">Pedidos para Recojo</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[('delivery_type', '=', 'pickup')]</field>
        <field name="context">{
            'search_default_pickup_ready': 1,
            'default_delivery_type': 'pickup'
        }</field>
        <field name="view_id" ref="view_sale_order_pickup_kanban"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay pedidos para recojo
            </p>
            <p>
                Los pedidos marcados como "Recojo en Local" aparecerán aquí.
                Puedes gestionarlos desde el estado Reservado hasta Recogido.
            </p>
        </field>
    </record>
</odoo>

